<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AI Video Generator</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2em; background: #f9f9f9; }
    h1 { margin-bottom: 0.6em; }
    label { font-weight: 600; display: block; margin-top: 1em; }
    input[type="file"], button { width: 100%; margin-top: 0.5em; padding: 0.75em; }
    button { background: #4f46e5; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 15px; }
    button:disabled { background: #a5b4fc; cursor: not-allowed; }
    #status { margin-top: 1em; font-weight: 600; color: #111827; }
    #videoPlayer { width: 100%; max-width: 720px; margin-top: 1em; display: none; background: #000; }
    #downloadLink { display: none; margin-top: 0.5em; }
    .note { color: #6b7280; font-size: 13px; margin-top: 4px; }
  </style>
</head>
<body>
  <h1>AI Video Generator</h1>

  <label for="audio">Upload Audio (MP3/WAV/M4A/AAC)</label>
  <input id="audio" type="file" accept=".mp3,.wav,.m4a,.aac" />
  <div class="note">We’ll transcribe with Whisper and let Gemini pick Drive videos. No text or query needed.</div>

  <button id="generateBtn" onclick="startGeneration()">Upload Audio &amp; Generate</button>

  <div id="status"></div>
  <video id="videoPlayer" controls></video>
  <a id="downloadLink" href="#" style="display:none;" download>Download Video</a>

  <script>
    let taskId = null;
    let pollInterval = null;

    function startGeneration() {
      const audioInput = document.getElementById("audio");
      const file = audioInput.files && audioInput.files[0];
      if (!file) {
        alert("Please upload an audio file (MP3/WAV/M4A/AAC).");
        return;
      }

      document.getElementById("generateBtn").disabled = true;
      document.getElementById("status").innerText = "Submitting task...";
      document.getElementById("downloadLink").style.display = "none";
      document.getElementById("videoPlayer").style.display = "none";

      const formData = new FormData();
      formData.append("audio_file", file);
      // script_text left blank – backend will transcribe
      formData.append("script_text", "");
      formData.append("suggested_folders", ""); // let backend pick via Gemini

      fetch("/generate-video-upload", {
        method: "POST",
        body: formData
      })
      .then(res => res.json())
      .then(data => {
        taskId = data.task_id;
        document.getElementById("status").innerText = "Task started. Polling status...";
        pollInterval = setInterval(checkStatus, 3000);
      })
      .catch(err => {
        console.error(err);
        document.getElementById("status").innerText = "Error submitting task.";
        document.getElementById("generateBtn").disabled = false;
      });
    }

    function checkStatus() {
      if (!taskId) return;

      fetch(`/task/${taskId}`)
      .then(res => res.json())
      .then(data => {
        document.getElementById("status").innerText = `${data.status.toUpperCase()}: ${data.progress || "Working..."}`;

        if (data.status === "completed") {
          clearInterval(pollInterval);
          document.getElementById("generateBtn").disabled = false;
          loadVideo();
        } else if (data.status === "failed") {
          clearInterval(pollInterval);
          document.getElementById("generateBtn").disabled = false;
          document.getElementById("status").innerText = "❌ Failed: " + (data.error || "Unknown error");
        }
      })
      .catch(err => {
        console.error(err);
        clearInterval(pollInterval);
        document.getElementById("generateBtn").disabled = false;
        document.getElementById("status").innerText = "Error checking status.";
      });
    }

    function loadVideo() {
      const videoPlayer = document.getElementById("videoPlayer");
      const downloadLink = document.getElementById("downloadLink");
      const videoUrl = `/download/${taskId}`;

      // Set up video player
      videoPlayer.src = videoUrl;
      videoPlayer.style.display = "block";
      
      // Set up download link
      downloadLink.href = videoUrl;
      downloadLink.style.display = "block";
      downloadLink.textContent = "Download Video";
      
      document.getElementById("status").innerText = "✅ Video ready!";

      // Start playing the video
      videoPlayer.play().catch(err => {
        console.error("Error playing video:", err);
      });
    }
  </script>
</body>
</html>
